<h1 class="rest_api_doc-h1">BAOBAB REST API </h1>
<h2 class="rest_api_doc-h2">Basic Access and Control of the BAOBAB Server</h2>
<header class="doc_toc-header rest_api_doc_div-people" id="00-people-toc">
    <div class="wrap-toc-div">
        <ul class="toc-ul">
            <li><a href="#main_overview_header-overview">OVERVIEW</a></li>
            <li><a href="#main_overview_header-methods">HTTP REST METHODS</a></li>
            <li><a href="#main_overview_header-plugins">REST PLUGINS</a></li>
            <li><a href="#main_overview_header-uri-structure">BASIC URI STRUCTURE</a><ul class="toc-ul">
                <li><a href="#main_overview_header-plugins-predicate">URI PROTOCOL PREDICATE</a></li>
                <li><a href="#main_overview_header-plugins-server_name">SERVER NAME</a></li>
                <li><a href="#main_overview_header-plugins-response_type">RESPONSE TYPE</a></li>
                <li><a href="#main_overview_header-plugins-plugin_name">PLUGIN NAME</a></li>
                <li><a href="#main_overview_header-plugins-subdirectory">SUBDIRECTORY</a></li>
                <li><a href="#main_overview_header-plugins-query">QUERY PARAMETERS</a></li>
            </ul></li>
            <li><a href="#main_overview_header-authentication">AUTHENTICATION</a><ul class="toc-ul">
                <li><a href="#main_overview_header-authentication-obtain-key">Obtaining a BAOBAB API Key</a></li>
                <li><a href="#main_overview_header-authentication-using-key">Using the BAOBAB API Key</a></li>
            </ul></li>
            <li><a href="#main_overview_header-sending_payload_data">SENDING BINARY/FILE DATA TO BAOBAB</a><ul class="toc-ul">
                <li><a href="#main_overview_header-sending_payload_data-post">POST</a></li>
                <li><a href="#main_overview_header-sending_payload_data-put">PUT</a></li>
            </ul></li>
            <li><a href="#main_overview_header-security">SECURITY</a><ul class="toc-ul">
                <li><a href="#main_overview_header-security-levels">SECURITY LEVELS</a><ul class="toc-ul">
                    <li><a href="#main_overview_header-security-levels-standard">Standard Users</a></li>
                    <li><a href="#main_overview_header-security-levels-managers">Managers</a></li>
                    <li><a href="#main_overview_header-security-levels-god">Main System ("God") Admin</li>
                </ul></li>
                <li><a href="#main_overview_header-security-tokens">SECURITY TOKENS</a></li>
            </ul></li>
            <li><a href="#main_overview_header-sample-curl">SAMPLE CURL-CALLING FUNCTION IN PHP</a></li>
        </ul>
    </div>
</header>
<div class=" class="rest_api_doc-main-content">
    <header class="uri_structure-header main_overview_header">
        <h3 class="rest_api_doc-h3" id="main_overview_header-overview">OVERVIEW</h3>
        <p class="main_doc-p">The BAOBAB REST API is a fairly basic, but powerful facility to access and affect the data on a Great Rift Valley Platform BAOBAB server. It is a fairly granular interface, designed to be generic.</p>
        <p class="main_doc-p">Security and flexibility are the main axes for the BAOBAB server. BAOBAB was created to be a low-level service; so commands and interactions are generally kept simple and generic. The REST API is designed to be coupled with SDKs on the client end that interpret and aggregate BAOBAB REST interactions into a more powerful and dense form.</p>
        <p class="main_doc-p">As a result of this, BAOBAB REST commands may seem "over-simple." This is deliberate.</p>
        
        <h3 class="rest_api_doc-h3" id="main_overview_header-methods">HTTP REST METHODS</h3>
        <p class="main_doc-p">REST interactions use <a href="http://www.restapitutorial.com/lessons/httpmethods.html">GET, POST, PUT, and DELETE</a> methods for connection and control. GET is the method used to extract data or log into the system, and the other methods are used to affect the data.</p>

        <h3 class="rest_api_doc-h3" id="main_overview_header-plugins">REST PLUGINS</h3>
        <p class="main_doc-p">The BAOBAB Server REST facility is implemented by a modular system that we call "plugins." These are code, written to implement a particular set of interactions with the server. The built-in plugins are <a href="#main_div-baseline">baseline</a>, <a href="#main_div-people">people</a>, <a href="#main_div-places">places</a> and <a href="#main_div-things">things</a>. These will be covered individally in greater detail below.</p>

        <h3 class="rest_api_doc-h3" id="main_overview_header-uri-structure">BASIC URI STRUCTURE</h3>
        <p class="main_doc-p">BAOBAB REST URIs consist of six fundamental parts:</p>
        <div class="uri_display-div">
            <code class="uri-code"><span class="uri_protocol-span">http[s]://</span><span class="uri_server-span">&lt;YOUR SERVER NAME&gt;</span><span class="uri_response_type-span">/[json|xml|xsd]</span><span class="uri_plugin-span">/&lt;PLUGIN NAME&gt;</span><span class="uri_subdirectory-span">/&lt;SUBDIRECTORY&gt;</span><span class="uri_query-span">?&lt;QUERY PARAMETERS&gt;</span></code>
        </div>
        <p class="main_doc-p">As these are standard URIs, all characters must be "URI-friendly." For example, spaces must be indicated by the use of plus signs ("<code class="uri_query-span">+</code>"), or URI-encoded space characters ("<code class="uri_query-span">%20</code>").</p>

        <h4 class="rest_api_doc-h4" id="main_overview_header-plugins-predicate"><span class="uri_protocol-span">URI PROTOCOL PREDICATE</span></h4>
        <p class="main_doc-p">This will allways be either "<code class="uri_protocol-span">http://</code>" or "<code class="uri_protocol-span">https://</code>". BAOBAB can be configured to require TLS/SSL (https) for all interactions, none, or login-only. It is highly recommended that it never be configured for http-only (non-TLS) in a production environment.</p>

        <h4 class="rest_api_doc-h4" id="main_overview_header-plugins-server_name"><span class="uri_server-span">SERVER NAME</span></h4>
        <p class="main_doc-p">This is the domain name and path to the entrypoint of the BAOBAB server. An example might be "<code class="uri_server-span">example.com/baobab-server-entry/entrypoint.php</code>".</p>

        <h4 class="rest_api_doc-h4" id="main_overview_header-plugins-response_type"><span class="uri_response_type-span">RESPONSE TYPE</span></h4>
        <p class="main_doc-p">This is the expected data response type. The choices are: <code class="uri_response_type-span"><a href="https://json.org">json</a></code>, <code class="uri_response_type-span"><a href="https://en.wikipedia.org/wiki/XML">xml</a></code> and <code class="uri_response_type-span"><a href="https://en.wikipedia.org/wiki/XML_Schema_(W3C)">xsd</a></code> (all lowercase).</p>
        <p class="main_doc-p">JSON and XML will be used for most interactions. XSD (XML Schema) is a special case. If you require this as a response type, then anything in the URI beyond the plugin name is ignored, and you will only get a comprehensive XML Schema document from the server. This schema will cover all possible responses from the plugin.</p>
        <p class="main_doc-p">There are a couple of "plugin-less" commands: "<code class="uri_plugin-span">login</code>" and "<code class="uri_plugin-span">logout</code>". If these are specified, then only plain text will be returned.</p>

        <h4 class="rest_api_doc-h4" id="main_overview_header-plugins-plugin_name"><span class="uri_plugin-span">PLUGIN NAME</span></h4>
        <p class="main_doc-p">This is the "top-level" directory for the plugin that is to handle the REST interaction.</p>

        <h4 class="rest_api_doc-h4" id="main_overview_header-plugins-subdirectory"><span class="uri_subdirectory-span">SUBDIRECTORY</span></h4>
        <p class="main_doc-p">This is one or more directories that specify the resource location, within the plugin, that will be the target of the REST query. All subdirectories are to be delimited by forward-slash ("<code class="uri_subdirectory-span">/</code>") characters.</p>

        <h4 class="rest_api_doc-h4" id="main_overview_header-plugins-query"><span class="uri_query-span">QUERY PARAMETERS</span></h4>
        <p class="main_doc-p">These are parameters that are applied to the resource interaction. These will always be prefaced with a question mark ("<code class="uri_query-span">?</code>"), and delimited by ampersands ("<code class="uri_query-span">&amp;</code>"). They may or may not require an equals sign (depending on whether or not a value is being transmitted, like "<code class="uri_query-span">name=Marvin+The+Martian</code>"). Specifying just the name of a query parameter will assume that it is Boolean, and that the value is <code class="uri_query-span">true</code> (or <code class="uri_query-span">1</code>).</p>

        <h3 class="rest_api_doc-h3" id="main_overview_header-authentication">AUTHENTICATION</h3>
        <p class="main_doc-p">Like most REST implementations, BAOBAB relies on the assignment of temporary API keys to authenticate HTTP transactions. These keys are time-limited, random strings that are returned as a simple text response to a successful "<code class="uri_plugin-span">login</code>" command. The server can be configured to associate these with an IP address (if the key is presented from an IP address other than the one that originally logged in, the connection is refused), and/or refuse a connection while a connection is active (the API key was assigned, and has not yet timed out).</p>

        <h4 class="rest_api_doc-h4" id="main_overview_header-authentication-obtain-key">Obtaining a BAOBAB API Key</h4>
        <p class="main_doc-p">In order to obtain a key, you must login to the server, using the "<code class="uri_plugin-span">login</code>" command, like so:</p>
        <div class="uri_display-div">
            <code class="uri-code"><span class="uri_protocol-span">https://</span><span class="uri_server-span">example.com/entrypoint.php</span><span class="uri_plugin-span">/login</span><span class="uri_query-span">?login_id=me@example.com&amp;password=qwertyuiop</span></code>
        </div>
        <p class="main_doc-p">Note that there is no response type or subdirectory. You only have "<code class="uri_plugin-span">login</code>," followed immediately by a login ID and cleartext password as query parameters (not directories). These credentials are supplied by the BAOBAB server administrator.</p>
        <p class="main_doc-p">Upon successful login, the response will be a random 64-character string, returned as a simple HTTP text response. This is the API key. It will not be sent again, and cannot be retrieved. If it is lost, then you may need to wait until the login has expired, in order to try again (depending on how the server is set up).</p>
        <p class="main_doc-p">You cannot specify any operation other than "<code class="uri_plugin-span">login</code>" with your login credentials. All subsequent interactions require the API key.</p>

        <h4 class="rest_api_doc-h4" id="main_overview_header-authentication-using-key">Using the BAOBAB API Key</h4>
        <p class="main_doc-p">Once you have obtained the API Key, you must present it in <a href="https://en.wikipedia.org/wiki/Basic_access_authentication#Client_side">the standard HTTP Authentication (Authorization) Header</a>. The key must be placed in <strong>BOTH</strong> the login ID and password portions of the header, like so (Sample is PHP code for <a href="http://php.net/manual/en/book.curl.php">a cURL</a> call):</p>
        <pre>    // $api_key contains the string returned from the "login" call.
    curl_setopt($curl, CURLOPT_HTTPAUTH, CURLAUTH_BASIC);
    curl_setopt($curl, CURLOPT_USERPWD, "$api_key:$api_key");</pre>
        <p class="main_doc-p">This needs to be done for every interaction that requires a login. Failing to provide it will not terminate the interaction (unless it is doing something that specifically requires a login), but will likely limit the capabilities of the call. Providing an invalid key (or, possibly, using a different source IP address from that used to obtain the key) will result in a <code>403 Forbidden</code> response.</p>

        <h3 class="rest_api_doc-h3" id="main_overview_header-sending_payload_data">SENDING BINARY/FILE DATA TO BAOBAB</h3>
        <p class="main_doc-p">BAOBAB records are capable of holding fairly substantial binary data assets (although it is recommended that they not be too substantial, as this is a database application). For example, avatars or user images, associated with user records, or scans of identity documents.</p>
        <p class="main_doc-p">In order to send this data to BAOBAB, you must use either the POST or PUT HTTP methods. In both of the following methods, the data should be Base64-encoded:</p>

        <h4 class="rest_api_doc-h4" id="main_overview_header-sending_payload_data-post">POST</h4>
        <p class="main_doc-p">POST data is sent using the standard "<code><a href="https://www.w3schools.com/tags/att_form_enctype.asp">Multipart/form-data</a></code>" method. You can send this directly from a form in a Web page.</p>

        <h4 class="rest_api_doc-h4" id="main_overview_header-sending_payload_data-put">PUT</h4>
        <p class="main_doc-p">PUT data is sent using a generic inline method, as there is no explicit support for data uploads in PUT.</p>

        <h3 class="rest_api_doc-h3" id="main_overview_header-security">SECURITY</h3>
        <p class="main_doc-p">BAOBAB takes security quite seriously. Many steps have been taken, technically, to protect the system; even from intruders gaining code execution.</p>

        <h4 class="rest_api_doc-h4" id="main_overview_header-security-levels">SECURITY LEVELS</h4>
        <p class="main_doc-p">For the most part, BAOBAB login levels are a "flat plain," as opposed to a "hierarchy." There is a minimal hierarchy:</p>
        
        <h5 class="rest_api_doc-h5" id="main_overview_header-security-levels-standard">Standard Users</h5>
        <p class="main_doc-p">This is the most common type of login. These users have whatever permissions are granted by their assigned tokens (discussed next), which can be considerable. However, standard users cannot create other users or logins.</p>

        <h5 class="rest_api_doc-h5" id="main_overview_header-security-levels-managers">Managers</h5>
        <p class="main_doc-p">Managers are exactly like Standard Users, with the notable difference that Manager users are allowed to create other logins and/or users.</p>
        <p class="main_doc-p">Managers are created with a "pool" of security tokens (assigned by the Manager User that created them). They can only assign tokens as a subset (including the entire "pool") to users that they create. It is not possible for any user to assign tokens to which they do not have accessin their own "pool."</p>

        <h5 class="rest_api_doc-h5" id="main_overview_header-security-levels-god">Main System ("God") Admin</h5>
        <p class="main_doc-p">There is one single login that is granted full powers on the server. This is the Main Admin (or "God") user.</p>
        <p class="main_doc-p">The "God" user is specified by login ID in the server configuaration file, as well as the password.</p>
        <p class="main_doc-p">Any login can be "promoted" to the "God" user, simply by setting its ID in the configuation. The default is Login ID 2 (the first user created). This user is automatically a Manager User, and can access any resource in the system.</p>
        <p class="main_doc-p">The "God" login has a different API Key timeout from other logins; usually much shorter. It's a powerful ID that should not be used often, and should be held to higher standards than other logins.</p>
        
        <h4 class="rest_api_doc-h4" id="main_overview_header-security-tokens">SECURITY TOKENS</h4>
        <p class="main_doc-p">Access to resources on the BAOBAB server are controlled by "security tokens." These are simple integers, provided to logins, in a list. If the login has a token, then any resources on the server that have that token as a read or write ID can be accessed by that login.</p>
        <p class="main_doc-p">Every resource on the server has two IDs: read and write. These IDs are integers, and the server uses these to assign permissions to logged-in users. If the logged-in user has the read token, then that user can read the record. If they have the write token, then they can read or modify the record.</p>
        <p class="main_doc-p">Records with "0" as a read ID can be viewed by any visitor; not just logged-in users. No records can be modified by non-logged-in users; regardless of the IDs assigned them.</p>
        <p class="main_doc-p">Records with "1" as a read or write ID can be viewed and/or modified by any logged-in user.</p>
        <p class="main_doc-p">IDs greater than "1" will require that the logged-in user also have that token in their list of tokens.</p>
        <p class="main_doc-p">For security reasons, no logged-in user (other than the "God" login) can even know of the existence of tokens that they do not have in their list, and no record to which they do not have at least read permissions will ever be accessible.</p>
        <p class="main_doc-p">Tokens can never be removed. They are always available, so they can be reused. Security tokens can be assigned to multiple records. They are not exclusive.</p>
        <p class="main_doc-p">Tokens are managed by Manager Users, via the "<code>baseline</code>" plugin..</p>

        <h3 class="rest_api_doc-h3" id="main_overview_header-sample-curl">SAMPLE CURL-CALLING FUNCTION IN PHP</h3>
        <pre>/****************************************************************************************************************************/
/**
This function is provided as an example of making REST calls to BAOBAB, and to provide guidance for programmers creating their own REST clients.

\returns the resulting transfer from the server, as a string of bytes.
 */
function call_REST_API( $method,            /**< REQUIRED:  This is the method to call. It should be one of:
                                                            - 'GET'     This is considered the default, but should be provided anyway, in order to ensure that the intent is clear.
                                                            - 'POST'    This means that the resource needs to be created.
                                                            - 'PUT'     This means that the resource is to be modified.
                                                            - 'DELETE'  This means that the resource is to be deleted.
                                            */
                        $url,               ///< REQIRED:   This is the base URL for the call. It should include the entire URI, including query arguments.
                        $data_file = NULL,  ///< OPTIONAL:  Default is NULL. This is a POSIX pathname to a file to be uploaded to the server, along with the URL. This will be Base64-encoded, so it is not necessary for it to be already encoded.
                        $api_key = NULL,    ///< OPTIONAL:  Default is NULL. This is an API key from the BAOBAB server. It needs to be provided for any operation that requires user authentication.
                        &$httpCode = NULL   ///< OPTIONAL:  Default is NULL. If provided, this has a reference to an integer data item that will be set to any HTTP response code.
                        ) {
    
    // Initialize function local variables.
    $file = NULL;           // This will be a file handle, for uploads.
    $content_type = NULL;   // This is used to signal the content-type for uploaded files.
    $file_size = 0;         // This is the size, in bytes, of uploaded files.
    $temp_file_name = NULL; // This is a temporary file that is used to hold files before they sent to the server.
    
    // If a file is provided by the caller, we read it into a temporary location, and Base64-encode it.
    if ($data_file) {
        $file_location = $data_file['filepath'];
        $file_type = $data_file['type'];
        
        $temp_file_name = tempnam(sys_get_temp_dir(), 'RVP');
        $source_file = fopen($file_location, 'r');
        $file = fopen($temp_file_name, 'w');
        
        $file_data = base64_encode(fread($source_file, filesize($file_location)));
        fwrite($file, $file_data, strlen($file_data));
        
        fclose($file);
        fclose($source_file);

        $content_type = $file_type.':base64';
        $file_size = filesize($temp_file_name);
        $file = fopen($temp_file_name, 'rb');
    }

    $curl = curl_init();                    // Initialize the cURL handle.
    curl_setopt($curl, CURLOPT_URL, $url);  // This is the URL we are calling.
        
    // Different methods require different ways of dealing with any file that has been passed in.
    // The file is ignored for GET and DELETE.
    // We ask the server not to send us EXPECT (HTTP 100) calls for POST and PUT.
    switch (strtoupper(trim($method))) {    // Make sure the method is always uppercase.
        case "POST":
            curl_setopt($curl, CURLOPT_POST, true);
            
            // POST sends the file as a standard multipart/form-data item.
            if ($file) {
                curl_setopt($curl, CURLOPT_SAFE_UPLOAD, true);
                curl_setopt($curl, CURLOPT_HTTPHEADER, ['Expect:', 'Content-type: multipart/form-data']);
                $post = Array('payload'=> curl_file_create($temp_file_name, $content_type));
                curl_setopt($curl, CURLOPT_POSTFIELDS, $post);
            } else {
                curl_setopt($curl, CURLOPT_HTTPHEADER, ['Expect:']);
            }
            break;
            
        case "PUT":
            curl_setopt($curl, CURLOPT_HTTPHEADER, ['Expect:']);
            curl_setopt($curl, CURLOPT_PUT, true);
            
            // PUT requires a direct inline file transfer.
            if ($file) {
                curl_setopt($curl, CURLOPT_SAFE_UPLOAD, true);
                curl_setopt($curl, CURLOPT_INFILE, $file);
                curl_setopt($curl, CURLOPT_INFILESIZE, $file_size);
            }
            break;
            
        case "DELETE":
            curl_setopt($curl, CURLOPT_CUSTOMREQUEST, "DELETE");
    }

    // Authentication. We provide the API key here.
    if (isset($api_key)) {
        curl_setopt($curl, CURLOPT_HTTPAUTH, CURLAUTH_BASIC);
        curl_setopt($curl, CURLOPT_USERPWD, "$api_key:$api_key");
    }

    curl_setopt($curl, CURLOPT_HEADER, false);          // Do not return any headers, please.
    curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);   // Please return to sender as a function response.
    curl_setopt($curl, CURLOPT_VERBOSE, false);         // Let's keep this thing simple.
    
    $result = curl_exec($curl); // Do it to it.
    
    // See if everything went as planned. If not, report an error.
    if ($result === false) {
        $info = curl_getinfo($curl);
        $result = 'error occured during curl. Info: '.var_export($info);
    }
    
    // If they want a report, we send it.
    if (isset($httpCode)) {
        $httpCode = curl_getinfo($curl, CURLINFO_HTTP_CODE);
    }

    curl_close($curl);  // Bye, now.
    
    // If we had a file open for transfer, we close it now.
    if ($file) {
        fclose($file);
    }

    return $result;
}</pre>
    </header>
</div>
